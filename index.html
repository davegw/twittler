<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="application.css">
    <script src="jquery.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
    <script src="moment.min.js"></script>
    <script src="data_generator.js"></script>
  </head>
  <body>
    <script>
      // Function for converting times to user friendly format.
      var timeConverter = function(time) {
        return moment(time).fromNow();
      }

      $(document).ready(function(){
        // Get user's twitter handle.
        var defaultUser = "davegdub"//prompt("Please enter your twitter handle:") || "newbie";

        // Prepare html to append to page.
        var $body = $('body');
        var $nav = $("<div id='nav'><ul><li><h2>Home</h2></li><li><h2>@"+defaultUser+"</h2></li></div>");
        var $main = $("<div id='main'></div>");
        var $profile = $("<div id='profile'></div>");
        var $tweetList = $("<div id='tweet-master-container'></div>");
        var $tweetTitle = $("<div id='tweet-title'>Tweets</div>");
        var $moreTweets = $("<div id='more-tweets'>Recent Tweets</div>");
        var $tweetContainer = $("<div id='tweet-container'></div>");

        // Create page content.
        $body.html('').append($nav).append($main);
        $main.append($profile).append($tweetList);
        $tweetList.append($tweetTitle).append($moreTweets).append($tweetContainer);

        // Global variables.
        var lastTweet, loadedTweets, curProfile=defaultUser, lastProfileCount;

        // Load the specified tweets in the right column.
        function loadTweets(start, end, highlight) {
          var index = start, hiddenTweetCount = 0;
          var highlight = highlight || "";
          while(index <= end){
            var tweet = streams.home[index];
            var $tweet = $('<div></div>');
            $tweet.append('<div class="user-name"><a href="#">@'+tweet.user+'</a><span>'+timeConverter(tweet.created_at)+'</span></div><div class="message">'+ tweet.message + '</div>');
            $tweet.addClass(highlight && "highlight").addClass(tweet.user+" tweet").data("user", tweet.user).data("time", tweet.created_at);
            $tweet.prependTo('#tweet-container');
            $tweet.filter(".highlight").effect("highlight", {color: "#F3F781"}, 2000);
            // Hide tweets from others if a specific user is selected.
            if (curProfile !== defaultUser && tweet.user !== curProfile) {
              hiddenTweetCount--;
              $tweet.hide();
            }
            index++;
          }
          // Log the last tweet and count the number of tweets loaded.
          lastTweet = end+1;
          loadedTweets = end+1+hiddenTweetCount - start;
          // Count the current user's number of tweets.
          if (curProfile !== defaultUser) {
            lastProfileCount = streams.users[curProfile].length;
          }
        }

        // Load the user's profile in the left column.
        function loadProfile(user) {
          $("#profile").children().remove();
          var $profile = $('<div></div>');
          if (user === defaultUser) {
            $profile.append('<h1 class="profile-name"> @'+user+'</h1><p><span>Total network tweets:</span>'+streams.home.length+'</p><p><span>Last network tweet:</span>'+timeConverter(streams.home[streams.home.length-1].created_at)+'</p>');
          }
          else {
            var profileTweets = streams.users[user];
            $profile.append('<h1 class="profile-name"> @'+user+'</h1><p><span>Total tweets:</span>'+profileTweets.length+'</p><p><span>Last tweet:</span>'+timeConverter(profileTweets[profileTweets.length-1].created_at)+'</p>');
          }
          $profile.appendTo('#profile');
          curProfile = user;
        }
        
        // On initial page load, load tweets and default profile.
        loadTweets(0, streams.home.length - 1);
        loadProfile(curProfile);

        // Click handler for loading more tweets.
        $("#more-tweets").on("click", function() {
          $('.highlight').removeClass('highlight');
          loadTweets(lastTweet, streams.home.length-1, true);
          $("#more-tweets").text(loadedTweets+" tweets loaded");
        });

        // Click handler for selecting and displaying user profiles and tweets.
        $("#tweet-container").on("click", "a", function(){
          var user = $(this).closest(".tweet").data("user");
          curProfile = user;
          $("#tweet-container .tweet").hide();
          $("#tweet-container .tweet").filter("."+user).show();
          userSwitcher();
        });

        // Click handler for returning to home page.
        $("#nav").on("click", "h2", function() {
          curProfile = defaultUser;
          userSwitcher();
          $('#tweet-container .tweet').show();
        });

        // Perform these actions when a new user profile is selected.
        var userSwitcher = function() {
          loadProfile(curProfile);
          $("#more-tweets").trigger("click");
        }

        // Updates the time of existing tweets.
        function updateTime() {
          $(".tweet").each(function() {
            var $item = $(this);
            $item.find(".user-name span").text(timeConverter($item.data("time")));
          });
        }
        
        // Interval for loading new tweets automatically.
        // setInterval(function() {$("#more-tweets").trigger("click")}, 20000);
        
        // Calculate number of new tweets since last load.
        function tweetCounter(user) {
          if (user === defaultUser) {
            $("#more-tweets").text("Load "+(streams.home.length-lastTweet)+" more tweets");
          }
          else {
            $("#more-tweets").text("Load "+(streams.users[user].length-lastProfileCount)+" more tweets from @"+user);
          }
        }

        // Periodically update tweet count and profile stats.
        setInterval(function() {
          tweetCounter(curProfile);
          loadProfile(curProfile);
        }, 5000);

        // Update time stamps every 20 seconds.
        setInterval(function() {
          updateTime();
          console.log("hey")
        }, 20000);

        // Handle mouseover events for tweets.
        $("#tweet-container").on("mouseenter", ".tweet", function() {
          $(this).addClass("focused");
        });
        $("#tweet-container").on("mouseleave", ".tweet", function() {
          $(this).removeClass("focused");
        });
      });
    </script>
  </body>
</html>
