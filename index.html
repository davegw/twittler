<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="application.css">
    <script src="jquery.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
    <script src="moment.min.js"></script>
    <script src="data_generator.js"></script>
    <script src="underscore.js"></script>
    <script src="backbone.js"></script>
  </head>
  <body>
    <script>
      // Function for converting times to user friendly format.
      var timeConverter = function(time) {
        return moment(time).fromNow();
      }

      // Get user's twitter handle.
      var visitor = prompt("Please enter your twitter handle:") || "newuser";
      streams.users[visitor] = [];
      

      $(document).ready(function(){
        // Prepare html to append to page.
        var $body = $('body');
        var $nav = $("<div id='nav'><ul><li class='nav-item'><h2 id='home'>Home</h2></li><li class='nav-item'><h2 id='visitor'>@"+visitor+"</h2></li><li id='auto-load'>Auto-load Tweets: <input type='radio' name='auto-load' value='On'>On<input type='radio' name='auto-load' value='off' checked>Off</li></div>");
        var $main = $("<div id='main'></div>");
        var $profile = $("<div id='profile'></div>");
        var $tweetList = $("<div id='tweet-master-container'></div>");
        var $tweetTitle = $("<div id='tweet-title'>Tweets</div>");
        var $moreTweets = $("<div id='more-tweets'>Recent Tweets</div>");
        var $tweetContainer = $("<div id='tweet-container'></div>");

        // Create page content.
        $body.html('').append($nav).append($main);
        $main.append($profile).append($tweetList);
        $tweetList.append($tweetTitle).append($moreTweets).append($tweetContainer);

        var Profile = Backbone.Model.extend({
          defaults: function() {
            return {
              tweets: 0,
              lastTweet: "None"
            };
          }
        });

        var ProfileList = Backbone.Collection.extend({
          model: Profile,
          focusOnItem: function(user) {
            var focus = this.filter(function(item, index) {
              return item.get("user") == user;
            }, this);
            var focusProfile = new Profile(focus[0].toJSON());
            this.reset(focusProfile.toJSON());
          },
          addProfile: function(itemJSON) {
            this.add(itemJSON);
          }
        });

        var ProfileView = Backbone.View.extend({
          initialize: function() {
            this.model.on("change", this.render, this);
          },
          template: _.template('<h1 class="profile-name profile-home"> @<%=user%></h1><p><span>Total network tweets:</span><%=tweets%></p><p><span>Last network tweet:</span><%=lastTweet%></p><div id="write-tweet"><textarea rows=3 placeholder="Compose new Tweet...""></textarea><input type="submit" value="Tweet"></input><div>'),
          render: function() {
            this.$el.html(this.template(this.model.toJSON()));
            return this;
          }
        });

        var ProfileListView = Backbone.View.extend({
          el: $("#profile"),
          initialize: function() {
            this.collection.on("reset", this.addAll, this);
            this.collection.on("add", this.addOne, this);
          },
          render: function() {
            this.collection.forEach(this.addOne, this);
            return this;
          }, 
          addOne: function(profileItem) {
              var profileView = new ProfileView({model:profileItem});
              this.$el.html(profileView.render().el);
          },
          addAll: function() {
            this.collection.forEach(this.addOne, this);
          }
        });

        var profileList = new ProfileList();
        var tempUsers = users.slice(0);
        tempUsers.push(visitor);
        _.each(tempUsers, function(item, index) {
          var profileTweets = streams.users[item];
          var profile = new Profile({user:item, tweets:profileTweets.length});
          if (profile.get("tweets") > 0) {
            profile.set({lastTweet:profileTweets[profileTweets.length-1].created_at});
          }
          profileList.add(profile);
        });

        var ProfileRouter = Backbone.Router.extend({
          initialize: function(options) {
            this.collection = options.profileList;
          },
          routes: {
            "hi": "index",
            "users/:user": "show"
          },
          index: function() {
            alert("howdy");
          },
          start: function() {
            Backbone.history.start({pushState:true});
          },
          show: function(user) {
            this.collection.focusOnItem(user);
          }
        });

        function getBBProfile(user) {
          var profile = profileList.detect(function(item){
            return item.get("user") == user;
          });
          profileList.addProfile(profile.toJSON());
        }

        var profileListView = new ProfileListView({collection:profileList});
        $("#profile").append(profileListView.render().el);
        
        var go = new ProfileRouter({profileList:profileList});
        go.start();


        /*--------------------TWEET--------------------*/
        var Tweet = Backbone.Model.extend();

        var TweetView = Backbone.View.extend({
          template: _.template('<div class="user-name"><a class="name-link" href="#">@<%=user%></a><span class="user-time"><%=timeConverter(created_at)%></span><span class="retweet options"><a href="#">Retweet</a></span><span class="reply options"><a href="#">Reply</a></span></div><div class="message"><%=message%></div>'),
          className: "tweet",
          events: {
            "click .retweet": "retweet",
            "click .reply": "reply",
            "click a.name-link": "addPro"
          },
          render: function() {
            this.$el.html(this.template(this.model.toJSON()));
            return this;
          },
          retweet: function() {
            var rt = this.model.get("message");
            var user = this.model.get("user");
            $("#write-tweet").show();
            $("#write-tweet textarea").val("RT @"+user+": "+rt);
            $("textarea").focus();
          },
          reply: function() {
            var user = this.model.get("user")
            $("#write-tweet").show();
            $("#write-tweet textarea").val("@"+user+" ");
            $("textarea").focus();
          },
          addPro: function() {
            console.log(this.model);
            var user = this.model.get("user");
            getBBProfile(user);
            $("#more-tweets").trigger("click");
            getUserTweets(user);
          }
        });

        var TweetList = Backbone.Collection.extend({
          model: Tweet
        });

        var TweetListView = Backbone.View.extend({
          initialize: function() {
            this.collection.on("reset", function() {
              this.$el.children().remove();
              this.render();
            }, this);
          },
          el: $("#tweet-container"),
          render: function() {
            this.collection.forEach(this.addOne, this)
          },
          addOne: function(item) {
            var tweet = new Tweet(item.toJSON());
            var tweetView = new TweetView({model: tweet});
            this.$el.prepend(tweetView.render().el);
          }
        })

        var tweetList = new TweetList;
        function getBBTweets() {
          var tweetJSON = _.map(streams.home, function(item) {
            return {user:item.user, created_at:item.created_at, message:item.message};
          });
          tweetList.reset(tweetJSON);
        }
        function getUserTweets(user) {
          var tweetJSON = _.map(streams.users[user], function(item) {
            return {user:item.user, created_at:item.created_at, message:item.message};
          });
          tweetList.reset(tweetJSON);
        }
        getBBTweets();
        
        var tweetListView = new TweetListView({collection:tweetList});
        tweetListView.render();
        $("#tweet-container").append(tweetListView.el);



        setInterval(function() {
          profileList.forEach(function(item, index) {
            item.set({tweets: streams.users[item.get("user")].length});
            if (item.get("tweets") > 0) {
              item.set({lastTweet:streams.users[item.get("user")][streams.users[item.get("user")].length-1].created_at});
            }
          });
        }, 5000);

        // Global variables.
        var lastTweet, loadedTweets, defaultUser = "home", curProfile=defaultUser, lastProfileCount, autoLoad;

        // Click handler for loading more tweets.
        $("#more-tweets").on("click", function() {
          $('.highlight').removeClass('highlight');
          getBBTweets();
          $("#more-tweets").text("All tweets loaded");
        });

        // Navigation click handler for viewing visitor's profile.
        $("#nav").on("click", "#visitor", function() {
          getBBProfile(visitor);
          $("#more-tweets").trigger("click");
          getUserTweets(visitor);
        });

        // Click handler for returning to home page.
        $("#nav").on("click", "#home", function() {
          getBBProfile(visitor);
          $("#more-tweets").trigger("click");
        });

        // Updates the time of existing tweets.
        function updateTime() {
          $(".tweet").each(function() {
            var $item = $(this);
            $item.find(".user-name span.user-time").text(timeConverter($item.data("time")));
          });
        }
        
        // Interval for loading new tweets automatically.
        var autoLoadInterval = function() {
          autoLoad = setInterval(function() {$("#more-tweets").trigger("click")}, 3000);
        }
        
        // Calculate number of new tweets since last load.
        function tweetCounter() {
          $("#more-tweets").text("Load "+(streams.home.length-tweetList.length)+" more tweets");
        }

        // Periodically update tweet count and profile stats.
        setInterval(function() {
          tweetCounter();
        }, 5000);

        // Update time stamps every 20 seconds.
        setInterval(function() {
          updateTime();
        }, 20000);

        // Handle mouseover events for tweets.
        $("#tweet-container").on("mouseenter", ".tweet", function() {
          $(this).addClass("focused");
        });
        $("#tweet-container").on("mouseleave", ".tweet", function() {
          $(this).removeClass("focused");
        });

        // Handle tweet submission.
        $("#profile").on("click", "#write-tweet input[type='submit']", function() {
          var msg = $(this).prev("textarea");
          writeTweet(msg.val());
          msg.val("");
          $(this).effect("highlight", {color: "#55acee"}, 100).blur();
          getBBTweets();
        });

        // Toggle tweet input field from home page.
        $("#profile").on("click", "#show-tweet", function() {
          $("#write-tweet").toggle();
        });

        // Handle auto-load radio buttons.
        $("li#auto-load").on("change", "input[name='auto-load']", function() {
          $("#more-tweets").toggle();
          if ($(this).val() === "On") {
            return autoLoadInterval();
          }
          clearInterval(autoLoad);
        });
      });
    </script>
  </body>
</html>
